###############################################
##############                                #
############## ESSA IMAGEM √â PERSONALIZADA    #
############## SEMPRE QUE SAIR UMA NOVA VERS√ÉO#
############## IREI DISPONIBILIZAR            #
###############################################
version: "3.7"
services:

## --------------------------- N8N-ORACLE --------------------------- ##

  n8n_editor:
    # image: n8nio/n8n:latest ## Vers√£o do N8N
    image: romariobrito-n8n-oracle:latest ## Vers√£o do N8N
    command: start

    networks:
      minha_rede:
        aliases:
          - n8n  # Substituindo para o novo FQDN

    ports:
      - "${N8N_PORT}:5678"
    extra_hosts:
      - "${N8N_HOST_ALIAS}:${N8N_HOST_IP}"

    environment:
      ## üóÑÔ∏è Banco de Dados (PostgreSQL)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_DATABASE=${DB_NAME}
      - DB_POSTGRESDB_HOST=${DB_HOST}
      - DB_POSTGRESDB_PORT=${DB_PORT}
      - DB_POSTGRESDB_USER=${DB_USER}
      - DB_POSTGRESDB_PASSWORD=${DB_PASS}

      ## üîê Criptografia
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      # üß† Performance
      - N8N_DIAGNOSTICS_ENABLED=${N8N_DIAGNOSTICS_ENABLED}
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL}
      - N8N_PAYLOAD_SIZE_MAX=${N8N_PAYLOAD_SIZE_MAX}
      - NODE_OPTIONS=--max-old-space-size=4096 # Aumenta limite de heap do Node.js
      - N8N_EXECUTIONS_PROCESS=own             # Executar cada execu√ß√£o em processo separado
      - CODE_ENABLE_STDOUT=true       # (Opcional) Habilita console.log em n√≥s de C√≥digo

      ## üåê URLs e Configura√ß√µes de Acesso
      - N8N_HOST=${N8N_HOST}
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - N8N_PROTOCOL=${N8N_PROTOCOL}

      ## ‚öôÔ∏è Ambiente de Execu√ß√£o
      - NODE_ENV=production
      - EXECUTIONS_MODE=queue
      - EXECUTIONS_TIMEOUT=${EXECUTIONS_TIMEOUT}
      - EXECUTIONS_TIMEOUT_MAX=${EXECUTIONS_TIMEOUT_MAX}
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
      - N8N_RUNNERS_ENABLED=true
      - N8N_RUNNERS_MODE=internal

      ## üì¶ Pacotes e N√≥s Comunit√°rios
      - N8N_REINSTALL_MISSING_PACKAGES=true
      - N8N_COMMUNITY_PACKAGES_ENABLED=true
      - N8N_NODE_PATH=/home/node/.n8n/nodes
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false # Enforce permiss√µes de arquivos de configura√ß√£o
      - N8N_CUSTOM_EXTENSIONS=/usr/local/lib/node_modules/n8n-nodes-oracle # Caminho para extens√µes personalizadas
      - NODE_FUNCTION_ALLOW_EXTERNAL=moment,lodash,moment-with-locales      # Bibliotecas JS externas permitidas

      ## üìß SMTP (Envio de E-mails)
      - N8N_SMTP_SENDER=${SMTP_SENDER}
      - N8N_SMTP_USER=${SMTP_USER}
      - N8N_SMTP_PASS=${SMTP_PASS}
      - N8N_SMTP_HOST=${SMTP_HOST}
      - N8N_SMTP_PORT=${SMTP_PORT}
      - N8N_SMTP_SSL=${SMTP_SSL}

      ## üîÅ Redis (Fila de Execu√ß√£o)
      - QUEUE_BULL_REDIS_HOST=${REDIS_HOST}
      - QUEUE_BULL_REDIS_PORT=${REDIS_PORT}
      - QUEUE_BULL_REDIS_DB=${REDIS_DB}

      # ‚ö° Cache Redis (Fun√ß√µes customizadas)
      - N8N_FUNCTION_REDIS_CACHE=true          # Habilita cache Redis para fun√ß√µes customizadas
      - N8N_FUNCTION_REDIS_CACHE_TTL=3600      # Tempo de cache Redis em segundos

      ## üìä M√©tricas
      - N8N_METRICS=true
      - N8N_METRICS_INCLUDE_QUEUE_METRICS=true
      - N8N_METRICS_QUEUE_METRICS_INTERVAL=60
      - QUEUE_HEALTH_CHECK_ACTIVE=true

      ## ‚è±Ô∏è Execu√ß√µes e Limpeza
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336

      ## üß† Recursos de IA
      - N8N_AI_ENABLED=false
      - N8N_AI_PROVIDER=openai
      - N8N_AI_OPENAI_API_KEY=

      ## üß∞ Permiss√µes em Fun√ß√µes Personalizadas
      - NODE_FUNCTION_ALLOW_BUILTIN=*
      - NODE_FUNCTION_ALLOW_EXTERNAL=moment,lodash

      ## üïí Fuso Hor√°rio
      - GENERIC_TIMEZONE=${TZ}
      - TZ=${TZ}

      # üîê Seguran√ßa e Oracle
      - N8N_SECURE_COOKIE=false              # Cookies seguros
      - TNS_ADMIN=/opt/oracle/instantclient/network/admin # Diret√≥rio de configura√ß√£o Oracle
      - LD_LIBRARY_PATH=/opt/oracle/instantclient        # Caminho para libs Oracle

      - N8N_EXPRESS_TRUST_PROXY=true
      
    configs:
      - source: tnsnames_ora_config
        target: /opt/oracle/instantclient/network/admin/tnsnames.ora
      - source: sqlnet_ora_config
        target: /opt/oracle/instantclient/network/admin/sqlnet.ora

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "2"
          memory: 2048M
      labels:
        - traefik.enable=true
        - traefik.http.routers.n8n_editor.rule=Host(`${N8N_HOST}`) ## Url do Editor do N8N
        - traefik.http.routers.n8n_editor.entrypoints=websecure
        - traefik.http.routers.n8n_editor.priority=1
        - traefik.http.routers.n8n_editor.tls.certresolver=letsencryptresolver
        - traefik.http.routers.n8n_editor.service=n8n_editor
        - traefik.http.services.n8n_editor.loadbalancer.server.port=5678
        - traefik.http.services.n8n_editor.loadbalancer.passHostHeader=1

## --------------------------- N8N-ORACLE --------------------------- ##

  n8n_webhook:
    image: n8nio/n8n:latest ## Vers√£o do N8N
    command: webhook

    networks:
      minha_rede:
        aliases:
          - n8n  # Substituindo para o novo FQDN

    environment:
      ## üóÑÔ∏è Banco de Dados (PostgreSQL)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_DATABASE=${DB_NAME}
      - DB_POSTGRESDB_HOST=${DB_HOST}
      - DB_POSTGRESDB_PORT=${DB_PORT}
      - DB_POSTGRESDB_USER=${DB_USER}
      - DB_POSTGRESDB_PASSWORD=${DB_PASS}

      - N8N_DIAGNOSTICS_ENABLED=${N8N_DIAGNOSTICS_ENABLED}
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL}
      - N8N_PAYLOAD_SIZE_MAX=${N8N_PAYLOAD_SIZE_MAX}

      ## üîê Criptografia
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      # üß† Performance
      - N8N_DIAGNOSTICS_ENABLED=${N8N_DIAGNOSTICS_ENABLED}
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL}
      - N8N_PAYLOAD_SIZE_MAX=${N8N_PAYLOAD_SIZE_MAX}
      - NODE_OPTIONS=--max-old-space-size=4096 # Aumenta limite de heap do Node.js
      - N8N_EXECUTIONS_PROCESS=own             # Executar cada execu√ß√£o em processo separado
      - CODE_ENABLE_STDOUT=true       # (Opcional) Habilita console.log em n√≥s de C√≥digo

      ## üåê URLs e Configura√ß√µes de Acesso
      - N8N_HOST=${N8N_HOST}
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - N8N_PROTOCOL=${N8N_PROTOCOL}

      ## ‚öôÔ∏è Ambiente de Execu√ß√£o
      - NODE_ENV=production
      - EXECUTIONS_MODE=queue
      - EXECUTIONS_TIMEOUT=${EXECUTIONS_TIMEOUT}
      - EXECUTIONS_TIMEOUT_MAX=${EXECUTIONS_TIMEOUT_MAX}
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
      - N8N_RUNNERS_ENABLED=true
      - N8N_RUNNERS_MODE=internal

      ## üì¶ Pacotes e N√≥s Comunit√°rios
      - N8N_REINSTALL_MISSING_PACKAGES=true
      - N8N_COMMUNITY_PACKAGES_ENABLED=true
      - N8N_NODE_PATH=/home/node/.n8n/nodes
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false # Enforce permiss√µes de arquivos de configura√ß√£o
      - N8N_CUSTOM_EXTENSIONS=/usr/local/lib/node_modules/n8n-nodes-oracle # Caminho para extens√µes personalizadas
      - NODE_FUNCTION_ALLOW_EXTERNAL=moment,lodash,moment-with-locales      # Bibliotecas JS externas permitidas

      ## üìß SMTP (Envio de E-mails)
      - N8N_SMTP_SENDER=${SMTP_SENDER}
      - N8N_SMTP_USER=${SMTP_USER}
      - N8N_SMTP_PASS=${SMTP_PASS}
      - N8N_SMTP_HOST=${SMTP_HOST}
      - N8N_SMTP_PORT=${SMTP_PORT}
      - N8N_SMTP_SSL=${SMTP_SSL}

      ## üîÅ Redis (Fila de Execu√ß√£o)
      - QUEUE_BULL_REDIS_HOST=${REDIS_HOST}
      - QUEUE_BULL_REDIS_PORT=${REDIS_PORT}
      - QUEUE_BULL_REDIS_DB=${REDIS_DB}

      # ‚ö° Cache Redis (Fun√ß√µes customizadas)
      - N8N_FUNCTION_REDIS_CACHE=true          # Habilita cache Redis para fun√ß√µes customizadas
      - N8N_FUNCTION_REDIS_CACHE_TTL=3600      # Tempo de cache Redis em segundos

      ## üìä M√©tricas
      - N8N_METRICS=true
      - N8N_METRICS_INCLUDE_QUEUE_METRICS=true
      - N8N_METRICS_QUEUE_METRICS_INTERVAL=60
      - QUEUE_HEALTH_CHECK_ACTIVE=true

      ## ‚è±Ô∏è Execu√ß√µes e Limpeza
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336

      ## üß† Recursos de IA
      - N8N_AI_ENABLED=false
      - N8N_AI_PROVIDER=openai
      - N8N_AI_OPENAI_API_KEY=

      ## üß∞ Permiss√µes em Fun√ß√µes Personalizadas
      - NODE_FUNCTION_ALLOW_BUILTIN=*
      - NODE_FUNCTION_ALLOW_EXTERNAL=moment,lodash

      ## üïí Fuso Hor√°rio
      - GENERIC_TIMEZONE=${TZ}
      - TZ=${TZ}

      # üîê Seguran√ßa e Oracle
      - N8N_SECURE_COOKIE=false              # Cookies seguros
      - TNS_ADMIN=/opt/oracle/instantclient/network/admin # Diret√≥rio de configura√ß√£o Oracle
      - LD_LIBRARY_PATH=/opt/oracle/instantclient        # Caminho para libs Oracle

      - N8N_EXPRESS_TRUST_PROXY=true

    configs:
      - source: tnsnames_ora_config
        target: /opt/oracle/instantclient/network/admin/tnsnames.ora
      - source: sqlnet_ora_config
        target: /opt/oracle/instantclient/network/admin/sqlnet.ora
      
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "2"
          memory: 2048M
      labels:
        - traefik.enable=true
        - traefik.http.routers.n8n_webhook.rule=(Host(`${WEBHOOK_URL}`)) ## Url do Webhook do N8N
        - traefik.http.routers.n8n_webhook.entrypoints=websecure
        - traefik.http.routers.n8n_webhook.priority=1
        - traefik.http.routers.n8n_webhook.tls.certresolver=letsencryptresolver
        - traefik.http.routers.n8n_webhook.service=n8n_webhook
        - traefik.http.services.n8n_webhook.loadbalancer.server.port=5678
        - traefik.http.services.n8n_webhook.loadbalancer.passHostHeader=1

## --------------------------- N8N-ORACLE --------------------------- ##

  n8n_worker:
    image: n8nio/n8n:latest ## Vers√£o do N8N
    command: worker --concurrency=10

    networks:
      minha_rede:
        aliases:
          - n8n  # Substituindo para o novo FQDN

    environment:
      ## üóÑÔ∏è Banco de Dados (PostgreSQL)
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_DATABASE=${DB_NAME}
      - DB_POSTGRESDB_HOST=${DB_HOST}
      - DB_POSTGRESDB_PORT=${DB_PORT}
      - DB_POSTGRESDB_USER=${DB_USER}
      - DB_POSTGRESDB_PASSWORD=${DB_PASS}

      - N8N_DIAGNOSTICS_ENABLED=${N8N_DIAGNOSTICS_ENABLED}
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL}
      - N8N_PAYLOAD_SIZE_MAX=${N8N_PAYLOAD_SIZE_MAX}

      ## üîê Criptografia
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      # üß† Performance
      - N8N_DIAGNOSTICS_ENABLED=${N8N_DIAGNOSTICS_ENABLED}
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL}
      - N8N_PAYLOAD_SIZE_MAX=${N8N_PAYLOAD_SIZE_MAX}
      - NODE_OPTIONS=--max-old-space-size=4096 # Aumenta limite de heap do Node.js
      - N8N_EXECUTIONS_PROCESS=own             # Executar cada execu√ß√£o em processo separado
      - CODE_ENABLE_STDOUT=true       # (Opcional) Habilita console.log em n√≥s de C√≥digo

      ## üåê URLs e Configura√ß√µes de Acesso
      - N8N_HOST=${N8N_HOST}
      - N8N_EDITOR_BASE_URL=${N8N_EDITOR_BASE_URL}
      - WEBHOOK_URL=${WEBHOOK_URL}
      - N8N_PROTOCOL=${N8N_PROTOCOL}

      ## ‚öôÔ∏è Ambiente de Execu√ß√£o
      - NODE_ENV=production
      - EXECUTIONS_MODE=queue
      - EXECUTIONS_TIMEOUT=${EXECUTIONS_TIMEOUT}
      - EXECUTIONS_TIMEOUT_MAX=${EXECUTIONS_TIMEOUT_MAX}
      - OFFLOAD_MANUAL_EXECUTIONS_TO_WORKERS=true
      - N8N_RUNNERS_ENABLED=true
      - N8N_RUNNERS_MODE=internal

      ## üì¶ Pacotes e N√≥s Comunit√°rios
      - N8N_REINSTALL_MISSING_PACKAGES=true
      - N8N_COMMUNITY_PACKAGES_ENABLED=true
      - N8N_NODE_PATH=/home/node/.n8n/nodes
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false # Enforce permiss√µes de arquivos de configura√ß√£o
      - N8N_CUSTOM_EXTENSIONS=/usr/local/lib/node_modules/n8n-nodes-oracle # Caminho para extens√µes personalizadas
      - NODE_FUNCTION_ALLOW_EXTERNAL=moment,lodash,moment-with-locales      # Bibliotecas JS externas permitidas

      ## üìß SMTP (Envio de E-mails)
      - N8N_SMTP_SENDER=${SMTP_SENDER}
      - N8N_SMTP_USER=${SMTP_USER}
      - N8N_SMTP_PASS=${SMTP_PASS}
      - N8N_SMTP_HOST=${SMTP_HOST}
      - N8N_SMTP_PORT=${SMTP_PORT}
      - N8N_SMTP_SSL=${SMTP_SSL}

      ## üîÅ Redis (Fila de Execu√ß√£o)
      - QUEUE_BULL_REDIS_HOST=${REDIS_HOST}
      - QUEUE_BULL_REDIS_PORT=${REDIS_PORT}
      - QUEUE_BULL_REDIS_DB=${REDIS_DB}

      # ‚ö° Cache Redis (Fun√ß√µes customizadas)
      - N8N_FUNCTION_REDIS_CACHE=true          # Habilita cache Redis para fun√ß√µes customizadas
      - N8N_FUNCTION_REDIS_CACHE_TTL=3600      # Tempo de cache Redis em segundos

      ## üìä M√©tricas
      - N8N_METRICS=true
      - N8N_METRICS_INCLUDE_QUEUE_METRICS=true
      - N8N_METRICS_QUEUE_METRICS_INTERVAL=60
      - QUEUE_HEALTH_CHECK_ACTIVE=true

      ## ‚è±Ô∏è Execu√ß√µes e Limpeza
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336

      ## üß† Recursos de IA
      - N8N_AI_ENABLED=false
      - N8N_AI_PROVIDER=openai
      - N8N_AI_OPENAI_API_KEY=

      ## üß∞ Permiss√µes em Fun√ß√µes Personalizadas
      - NODE_FUNCTION_ALLOW_BUILTIN=*
      - NODE_FUNCTION_ALLOW_EXTERNAL=moment,lodash

      ## üïí Fuso Hor√°rio
      - GENERIC_TIMEZONE=${TZ}
      - TZ=${TZ}

      # üîê Seguran√ßa e Oracle
      - N8N_SECURE_COOKIE=false              # Cookies seguros
      - TNS_ADMIN=/opt/oracle/instantclient/network/admin # Diret√≥rio de configura√ß√£o Oracle
      - LD_LIBRARY_PATH=/opt/oracle/instantclient        # Caminho para libs Oracle

      - N8N_EXPRESS_TRUST_PROXY=true

    configs:
      - source: tnsnames_ora_config
        target: /opt/oracle/instantclient/network/admin/tnsnames.ora
      - source: sqlnet_ora_config
        target: /opt/oracle/instantclient/network/admin/sqlnet.ora
      
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "2"
          memory: 2048M

## --------------------------- N8N-ORACLE --------------------------- ##

networks:
  minha_rede: ## Nome da rede interna
    external: true
    name: minha_rede ## Nome da rede interna
